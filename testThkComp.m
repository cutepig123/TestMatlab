function main
close all, clc,clear

Taf9Pts_all =[198.266	207.866	215.143	199.612	207.949	216.825	202.517	208.736	220.146
181.055	184.001	190.12	185.08	187.499	193.295	188.557	191.287	200.226
194.343	196.574	195.251	201.463	204.424	200.764	205.783	209.005	204.778
185.213	198.479	195.926	188.57	204.89	200.719	194.09	208.887	204.084
189.698	195.53	197.972	190.101	196.649	200.769	193.537	199.975	201.613
180.923	230.095	208.709	178.937	218.011	199.605	182.639	205.88	187.418
185.068	204.153	220.458	179.651	195.684	210.649	176.485	184.008	197.213
189.794	196.074	198.716	189.536	194.96	197.801	190.527	195.854	199.11
193.995	190.695	184.313	194.427	190.955	185.12	199.475	196.361	189.218
189.499	191.679	192.016	202.019	210.24	215.486	178.045	178.48	179.852
198.796	207.183	215.287	199.691	207.825	216.617	203.765	208.614	219.554
182.024	184.696	191.23	184.758	187.455	194.146	188.821	191.168	200.067
194.059	196.678	195.307	201.116	205.221	201.466	206.474	210.066	205.695
186.289	197.62	195.723	189.756	205.026	200.51	194.242	209.351	204.886
189.911	196.054	198.482	190.106	196.426	200.099	193.478	200.28	201.986
181.254	229.726	209.123	179.712	218.354	200.238	182.329	205.569	187.533
185.142	204.007	219.601	179.883	196.241	210.759	177.104	184.792	198.147
190.413	195.912	198.75	189.486	194.76	198.404	191.441	196.504	199.809
193.316	190.756	184.131	194.274	190.448	184.542	200.09	195.972	190.625
189.572	190.757	192.07	201.497	210.799	216.108	176.463	178.736	181.104
198.402	206.639	214.777	199.246	207.446	216.82	202.939	208.816	219.567
182.039	184.555	190.139	184.867	188.022	194.589	188.738	191.762	200.572
194.334	196.849	195.719	200.871	204.885	200.437	206.43	209.843	205.455
185.58	198.035	196.001	188.853	204.305	200.298	194.023	209.477	205.297
189.699	195.448	197.574	189.764	195.785	199.773	194.015	200.285	201.776
181.131	229.252	209.195	179.04	217.955	199.588	182.912	205.934	187.84
184.751	203.901	219.631	180.263	195.437	210.473	177.351	184.737	199.095
190.02	195.909	198.809	190.003	194.98	198.46	191.421	196.827	199.914
193.615	190.45	184.147	194.071	190.93	185.282	200.342	196.198	190.411
190.119	191.39	191.28	201.288	210.482	215.61	177.725	179.553	180.07
198.639	207.62	215.432	199.925	208.344	216.852	203.136	208.41	218.183
180.651	183.591	191.718	184.388	187.376	194.077	188.812	191.717	200.14
194.486	197.166	195.528	201.367	205.233	200.984	206.766	210.407	205.956
185.728	197.71	195.829	189.132	204.503	200.763	194.028	208.813	205.368
189.411	195.273	198.338	190.148	196.61	200.579	193.157	200.075	203.299
180.933	229.854	209.064	178.98	218.037	199.574	182.521	205.823	188.381
185.007	204.26	219.212	179.355	195.638	210.63	177.541	184.816	198.357
190.721	196.087	198.635	189.703	195.208	198.514	191.264	196.421	199.816
193.665	190.777	184.488	194.349	191.295	186.15	200.58	197.105	190.512
189.426	191.214	192.269	200.917	209.98	215.785	178.784	179.534	180.754
199.183	207.427	215.083	199.684	208.059	216.778	203.507	208.369	219.378
182.202	184.43	190.176	185.242	187.547	194.341	189.094	191.846	200.394
194.839	197.057	195.641	201.076	205.366	201.385	206.602	210.166	205.828
186.054	198.156	195.707	189.227	204.056	200.195	194.02	209.423	205.067
190.017	195.085	197.06	189.658	196.211	200.898	193.78	200.702	201.724
181.37	230.273	209.228	179.023	218.059	199.854	183	206.218	188.064
185.061	203.848	219.373	179.242	195.331	210.347	177.316	185.094	197.873
190.333	195.907	198.733	189.86	195.499	198.326	191.404	196.658	199.605
193.613	190.653	183.996	194.554	190.889	185.395	199.83	196.316	190.055
190.201	191.594	191.866	201.651	210.202	214.724	178.066	179.884	180.374
198.477	207.65	215.156	199.5	208.197	216.589	203.607	208.842	219.919
182.087	184.215	190.702	184.619	187.576	193.766	188.887	192.141	200.5
194.617	196.548	195.716	200.441	205.326	200.766	206.572	210.302	206.713
186.06	197.638	196.062	188.877	204.353	199.77	193.744	208.934	204.63
190.391	195.681	197.994	189.531	196.353	200.446	193.898	200.141	202.589
181.297	229.989	209.922	179.945	217.766	199.515	183.42	205.989	187.52
184.948	204.249	219.943	179.795	196.253	210.78	177.688	185.013	198.56
190.372	195.845	198.399	190.084	195.638	198.626	191.334	197.031	199.979
193.786	190.204	184.386	193.85	191.347	185.189	199.772	196.614	189.796
189.52	191.554	192.384	201.004	210.117	215.19	177.748	179.035	181.382
198.188	207.477	214.872	199.214	207.555	216.108	203.396	208.618	219.398
181.349	183.983	191.304	184.738	187.572	194.131	189.567	191.997	200.511
194.343	196.322	195.394	201.27	205.607	201.644	206.528	210.514	206.603
185.152	198.183	195.73	188.424	204.442	200.106	194.123	209.475	204.7
189.974	195.387	198.072	190.01	196.119	200.03	193.036	199.902	202.125
181.325	229.808	209.375	179.462	218.33	199.729	182.651	205.983	187.146
185.321	203.689	219.057	180.047	195.446	210.463	177.715	185.116	198.546
190.392	195.774	198.894	189.169	195.454	198.425	191.993	196.818	200.595
194.184	191.566	184.437	194.042	190.872	186.069	200.036	196.215	190.204
189.514	191.289	191.912	201.101	210.436	215.347	177.872	178.216	180.032
198.429	207.595	215.606	199.911	208.402	216.931	203.01	208.879	219.857
181.512	184.333	190.136	184.176	187.685	193.583	189.064	192.581	200.076
194.478	196.452	195.907	200.641	205.317	200.559	206.613	210.042	206.321
185.672	198.132	195.591	188.891	204.286	199.967	194.58	209.055	204.312
189.957	195.528	198.284	189.669	196.52	200.803	193.801	200.43	202.204
180.853	229.986	208.913	179.35	217.863	199.475	182.477	205.989	187.997
184.866	203.578	219.243	179.767	195.738	210.664	177.781	185.179	198.217
190.431	195.946	199.082	191.03	195.499	198.272	191.389	196.647	200.422
193.745	190.173	184.689	193.937	190.547	185.463	199.667	196.317	190.959
189.394	191.234	191.931	201.224	210.293	215.577	178.411	179.971	181.265

];

DZ_PerCam=[
    -0.799	-1.269	-1.58	-0.886	-2.361	-0.502
-1.196	-1.008	-1.687	-0.683	-2.177	-0.358
-0.799	-1.119	-1.65	-0.787	-2.5	-0.455
-0.756	-1.343	-1.427	-0.949	-2.097	-0.555
-0.988	-1.09	-1.367	-0.666	-1.746	-0.242
-0.597	-0.671	-1.262	-0.589	-1.927	-0.508
-0.76	-1.071	-1.414	-0.62	-2.069	-0.17
-0.829	-0.84	-1.506	-0.615	-2.183	-0.39
-0.714	-0.666	-1.27	-0.58	-1.826	-0.494
-0.759	-1.069	-1.417	-0.846	-2.075	-0.624
-0.851	-1.095	-1.732	-0.814	-2.613	-0.532
-1.098	-1.088	-1.794	-0.662	-2.49	-0.236
-1.009	-0.975	-1.751	-0.676	-2.492	-0.378
-1.002	-1.083	-1.624	-0.698	-2.247	-0.313
-0.695	-0.976	-1.412	-0.681	-2.128	-0.386
-0.656	-0.77	-1.487	-0.564	-2.319	-0.358
-0.657	-0.864	-1.506	-0.636	-2.356	-0.409
-0.647	-0.772	-1.429	-0.527	-2.212	-0.283
-0.75	-0.417	-1.43	-0.413	-2.109	-0.409
-0.952	-1.063	-1.538	-0.802	-2.124	-0.54
-0.932	-0.625	-1.827	-0.535	-2.722	-0.446
-1.033	-0.724	-1.784	-0.557	-2.535	-0.391
-0.987	-0.688	-1.862	-0.525	-2.736	-0.362
-0.901	-0.747	-1.799	-0.503	-2.696	-0.26
-0.87	-0.729	-1.503	-0.463	-2.136	-0.198
-0.61	-0.515	-1.563	-0.399	-2.517	-0.283
-0.625	-0.658	-1.535	-0.476	-2.445	-0.295
-0.82	-0.548	-1.568	-0.403	-2.316	-0.258
-0.684	-0.205	-1.458	-0.255	-2.233	-0.304
-0.842	-0.693	-1.596	-0.51	-2.351	-0.327
-0.952	-0.89	-1.904	-0.498	-2.857	-0.106
-1.347	-0.282	-2.017	-0.268	-2.687	-0.254
-0.561	-0.946	-1.617	-0.628	-2.673	-0.311
-0.937	-0.784	-1.805	-0.497	-2.674	-0.209
-1.17	-0.524	-1.889	-0.372	-2.608	-0.219
-0.792	-0.551	-1.717	-0.327	-2.642	-0.102
-0.63	-0.689	-1.585	-0.466	-2.54	-0.242
-0.779	-0.586	-1.54	-0.289	-2.302	0.007
-0.793	-0.298	-1.442	-0.302	-2.091	-0.305
-0.689	-0.674	-1.485	-0.443	-2.28	-0.212
-0.914	-0.947	-2.023	-0.458	-3.133	0.031
-1.073	-0.744	-1.898	-0.467	-2.723	-0.191
-0.877	-0.933	-1.822	-0.646	-2.768	-0.358
-1.05	-0.995	-1.856	-0.565	-2.662	-0.136
-0.959	-0.657	-1.715	-0.4	-2.471	-0.143
-0.938	-0.645	-1.688	-0.466	-2.437	-0.286
-0.972	-0.639	-1.705	-0.326	-2.439	-0.012
-0.985	-0.892	-1.762	-0.485	-2.538	-0.078
-0.691	-0.521	-1.569	-0.362	-2.447	-0.204
-0.93	-0.846	-1.641	-0.586	-2.351	-0.325
-1.146	-0.887	-2.173	-0.526	-3.201	-0.165
-1.419	-0.727	-2.129	-0.401	-2.839	-0.075
-0.998	-0.709	-1.919	-0.464	-2.84	-0.219
-1.164	-0.437	-2.102	-0.279	-3.04	-0.12
-0.935	-0.665	-1.826	-0.384	-2.716	-0.102
-0.91	-0.608	-1.836	-0.377	-2.763	-0.145
-0.9	-0.784	-1.806	-0.42	-2.713	-0.057
-0.984	-0.688	-1.78	-0.345	-2.576	-0.003
-0.857	-0.228	-1.639	-0.114	-2.42	0
-0.939	-0.773	-1.682	-0.416	-2.426	-0.059
-1.591	-0.76	-2.391	-0.407	-3.191	-0.055
-1.467	-0.925	-2.152	-0.532	-2.836	-0.139
-1.005	-0.72	-1.957	-0.425	-2.908	-0.13
-1.313	-0.68	-2.134	-0.425	-2.955	-0.169
-1.074	-0.75	-1.803	-0.368	-2.532	0.013
-1.008	-0.897	-1.988	-0.466	-2.968	-0.034
-1.01	-0.868	-1.947	-0.523	-2.885	-0.178
-1.003	-0.597	-1.786	-0.299	-2.569	-0.002
-0.988	-0.484	-1.703	-0.325	-2.418	-0.166
-1.106	-0.823	-1.909	-0.519	-2.712	-0.215
-1.266	-1.134	-2.241	-0.628	-3.216	-0.122
-1.609	-0.801	-2.338	-0.445	-3.067	-0.09
-1.356	-1.11	-2.292	-0.607	-3.228	-0.103
-1.435	-1.051	-2.192	-0.561	-2.948	-0.072
-1.276	-1.006	-2.023	-0.609	-2.77	-0.211
-0.969	-0.683	-1.939	-0.434	-2.909	-0.186
-1.033	-0.974	-1.987	-0.567	-2.941	-0.161
-1.181	-0.866	-1.907	-0.409	-2.633	0.047
-1.121	-0.629	-1.926	-0.344	-2.73	-0.06
-1.259	-0.981	-1.927	-0.581	-2.596	-0.182
];

DT_all=DZ_PerCam(:,2:2:6)-DZ_PerCam(:,1:2:6);

Taf_all =[ mean(Taf9Pts_all(:,1:3),2) mean(Taf9Pts_all(:,4:6),2) mean(Taf9Pts_all(:,7:9),2) ];
T_all=Taf_all - DT_all;
N=size(T_all,1);    %Total rows
M=10;           %total wafers
T9Pts_all=Taf9Pts_all -[DT_all(:,1)*ones(1, 3) DT_all(:,2)*ones(1, 3) DT_all(:,3)*ones(1, 3)];

%compensate by all wafers
%[a,b]=myCompensation(T_all,DT_all,M)
[a,b]=myCompensation2(T_all,DT_all,M)
%[a,b]=myCompensation3(T_all,DT_all,M)

DTOptpair1=a*DT_all(:,1) + b*DT_all(:,3);
DTOpt_all=[DT_all(:,1) DTOptpair1 DT_all(:,3)];
TOpt_all =T_all + DTOpt_all;
TOpt9Pts_all=T9Pts_all +[DT_all(:,1)*ones(1, 3) DTOptpair1*ones(1, 3) DT_all(:,3)*ones(1, 3)];


RangeTall=zeros(M,3);
%plot the range of 'pair 1 average thickness without compensation'
RangeTall(:,1)=myRefactorAndCalc(T_all, M, @(Tsub)(max(Tsub(:,2))-min(Tsub(:,2))));
%plot the thickness variation of pair 1 with avrerage compensation
RangeTall(:,2)=myRefactorAndCalc(Taf_all, M, @(Tsub)(max(Tsub(:,2))-min(Tsub(:,2))));
%plot the thickness variation of pair 1 with optimal compensation
RangeTall(:,3)=myRefactorAndCalc(TOpt_all, M, @(Tsub)(max(Tsub(:,2))-min(Tsub(:,2))));

plotid=1;
subplot(2,2,plotid); plotid=plotid+1;
plot(RangeTall)
title('pair 1 average thickness repeatability')
xlabel('Wafer')
ylabel('Range(um)')
legend('without compensation','average compensation','optimal compensation')
%ylim([0 5])

RangeTall=zeros(M,3);
%plot the range of 'pair 1 average thickness without compensation'
RangeTall(:,1)=myRefactorAndCalc(T_all, M, @(Tsub)(max(Tsub(:,1))-min(Tsub(:,1))));
%plot the thickness variation of pair 1 with avrerage compensation
RangeTall(:,2)=myRefactorAndCalc(Taf_all, M, @(Tsub)(max(Tsub(:,1))-min(Tsub(:,1))));
%plot the thickness variation of pair 1 with optimal compensation
RangeTall(:,3)=myRefactorAndCalc(TOpt_all, M, @(Tsub)(max(Tsub(:,1))-min(Tsub(:,1))));

subplot(2,2,plotid); plotid=plotid+1;
plot(RangeTall)
title('pair 0 average thickness repeatability')
xlabel('Wafer')
ylabel('Range(um)')
legend('without compensation','average compensation','optimal compensation')

RangeTall=zeros(M,3);
%plot the range of 'pair 1 average thickness without compensation'
RangeTall(:,1)=myRefactorAndCalc(T_all, M, @(Tsub)(max(Tsub(:,3))-min(Tsub(:,3))));
%plot the thickness variation of pair 1 with avrerage compensation
RangeTall(:,2)=myRefactorAndCalc(Taf_all, M, @(Tsub)(max(Tsub(:,3))-min(Tsub(:,3))));
%plot the thickness variation of pair 1 with optimal compensation
RangeTall(:,3)=myRefactorAndCalc(TOpt_all, M, @(Tsub)(max(Tsub(:,3))-min(Tsub(:,3))));

subplot(2,2,plotid); plotid=plotid+1;
plot(RangeTall)
title('pair 2 average thickness repeatability')
xlabel('Wafer')
ylabel('Range(um)')
legend('without compensation','average compensation','optimal compensation')

%plot TTV variation

RangeTall=zeros(10,3);
RangeTall(:,1)=myRefactorAndCalc(T9Pts_all, M, @myTTVRep);
RangeTall(:,2)=myRefactorAndCalc(Taf9Pts_all , M, @myTTVRep);
RangeTall(:,3)=myRefactorAndCalc(TOpt9Pts_all, M, @myTTVRep);
subplot(2,2,plotid); plotid=plotid+1;
plot(RangeTall)
title('TTV repeatability')
xlabel('Wafer')
ylabel('Range(um)')
legend('without compensation','average compensation','optimal compensation')

%multiple rows, each row contains N point thickness
function Res=myTTVRep(T)
TTV=max(T,[],2)-min(T,[],2);
Res=max(TTV)-min(TTV);


function [a,b]=myCompensation(T_all,DT_all,M)
N=size(T_all,1);
A=[DT_all(:,1)-DT_all(:,3)  zeros(N,M)];
b=-[T_all(:,2)+DT_all(:,3)];
for i=1:M
    A(i:M:N, 1+i)=1;
end
X=A\b;
a=X(1);
b=1-a;


function [a,b]=myCompensation2(T_all,DT_all,M)
N=size(T_all,1);
A=[DT_all(:,1) DT_all(:,3)  zeros(N,M)];
b=-[T_all(:,2)];
for i=1:M
    A(i:M:N, 2+i)=1;
end
X=A\b;
a=X(1);
b=X(2);

function [a,b]=myCompensation3(T_all,DT_all,M)
N=size(T_all,1);
A=[DT_all(:,1) DT_all(:,3)];
b=0.5*(T_all(:,1)+T_all(:,3))-T_all(:,2);
X=A\b;
a=X(1);
b=X(2);

%T: Nx9
%M: Number wafers
%f: 
function Res=myRefactorAndCalc(T, M, f)
N=size(T,1);
NCase=N/M;
Res=zeros(M,1);
for i=1:M
	Tsub=T(i:M:N,:);
	Res(i) =f(Tsub);
end
	
